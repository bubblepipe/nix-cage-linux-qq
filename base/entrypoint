#!/usr/bin/env bash
set -e

grep '^user:' /etc/passwd  > /dev/null 2>&1 || echo "user:x:$DEMOTE_UID:$DEMOTE_GID::/home/user:/usr/bin/bash" >> /etc/passwd
grep '^user'  /etc/sudoers > /dev/null 2>&1 || echo "user ALL=(ALL) NOPASSWD:ALL"                              >> /etc/sudoers

chown                       \
    $DEMOTE_UID:$DEMOTE_GID \
    /home/user              \
    /home/user/*            \
    /home/user/.*           \
    /var/run/emacs

exec /usr/bin/demote             \
    --source=id                  \
    --uid $DEMOTE_UID            \
    --gid $DEMOTE_GID            \
    /usr/bin/emacs               \
    -- -nw -l /home/user/.emacs.d/init.el
